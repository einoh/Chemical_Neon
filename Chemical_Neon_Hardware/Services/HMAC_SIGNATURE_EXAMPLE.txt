/**
 * HMAC Signature Computation Example for Arduino/Hardware
 * 
 * This demonstrates how to compute the HMAC-SHA256 signature
 * for coin pulses before sending to the server.
 */

// Example in C/C++ for Arduino:
/*
#include <WiFi.h>
#include <mbedtls/md.h>

const char* SECRET_KEY = "dev-secret-key-change-before-production";

String computeHmacSignature(String machineId, int pulseCount, long timestamp) {
    // Create payload string: "MachineId:PulseCount"
    String payload = machineId + ":" + String(pulseCount);
    
    // Create message: "payload:timestamp"
    String message = payload + ":" + String(timestamp);
    
    // Compute HMAC-SHA256
    unsigned char hmac[32]; // SHA256 produces 32 bytes
    
    mbedtls_md_context_t ctx;
    mbedtls_md_init(&ctx);
    mbedtls_md_setup(&ctx, mbedtls_md_info_from_type(MBEDTLS_MD_SHA256), 1);
    mbedtls_md_hmac_starts(&ctx, (unsigned char*)SECRET_KEY, strlen(SECRET_KEY));
    mbedtls_md_hmac_update(&ctx, (unsigned char*)message.c_str(), message.length());
    mbedtls_md_hmac_finish(&ctx, hmac);
    mbedtls_md_free(&ctx);
    
    // Convert to hex string
    String signature = "";
    for(int i = 0; i < 32; i++) {
        if(hmac[i] < 16) signature += "0";
        signature += String(hmac[i], HEX);
    }
    
    return signature;
}

void sendCoinPulse(String machineId, int pulseCount) {
    // Get current timestamp (seconds since epoch)
    long timestamp = time(nullptr); // Requires setting system time
    
    // Compute signature
    String signature = computeHmacSignature(machineId, pulseCount, timestamp);
    
    // Create JSON payload
    String payload = "{";
    payload += "\"machineId\":\"" + machineId + "\",";
    payload += "\"pulseCount\":" + String(pulseCount) + ",";
    payload += "\"timestamp\":\"" + String(timestamp) + "\",";
    payload += "\"signature\":\"" + signature + "\"";
    payload += "}";
    
    // Send to server
    // POST http://your-server:5000/api/hardware/coin
    // Content-Type: application/json
    // Body: payload
}
*/

// Example in Python for testing:
/*
import hashlib
import hmac
import json
import time
import requests

SECRET_KEY = "dev-secret-key-change-before-production"
MACHINE_ID = "SITE_001"
API_URL = "http://localhost:5000/api/hardware/coin"

def compute_signature(machine_id, pulse_count, timestamp, secret_key):
    payload = f"{machine_id}:{pulse_count}"
    message = f"{payload}:{timestamp}"
    signature = hmac.new(
        secret_key.encode(),
        message.encode(),
        hashlib.sha256
    ).hexdigest()
    return signature

def send_coin_pulse(machine_id, pulse_count):
    timestamp = int(time.time())
    signature = compute_signature(machine_id, pulse_count, timestamp, SECRET_KEY)
    
    payload = {
        "machineId": machine_id,
        "pulseCount": pulse_count,
        "timestamp": str(timestamp),
        "signature": signature
    }
    
    response = requests.post(
        API_URL,
        json=payload,
        headers={"Content-Type": "application/json"}
    )
    
    print(f"Response: {response.status_code}")
    print(f"Body: {response.json()}")

# Test
send_coin_pulse(MACHINE_ID, 10)
*/
